# Quicker（macOS）MVP 设计文档

日期：2026-02-04  
主题：`quicker-mvp-design`  
依据：`quicker-mvp-prd.md`

## 1. 目标与范围

### 1.1 MVP 目标

- 提供“键盘优先”的剪切板历史：全局热键唤出居中面板，快速选择并粘贴后立即回到原工作流。
- 仅支持**文本**剪切板类型。
- 支持基础隐私控制：限制历史条数、清空、忽略指定 App。

### 1.2 非目标（MVP 不做）

- Snippets、图片/文件类型、云同步、收藏/Pin/标签、复杂搜索。

## 2. 关键决策（已确认）

- App 形态：**菜单栏常驻**（无 Dock 图标）。
- 发布渠道：**直接分发（签名+公证/DMG）**（非 MAS）。
- 粘贴策略：**自动优先 + 降级**  
  - 已授权「辅助功能/可访问性」：写入剪贴板 + 模拟 `⌘V`（自动粘贴）。  
  - 未授权：仅写入剪贴板并轻提示引导开启权限。
- 历史保存：**默认持久化**（重启后仍保留）。
- 翻页按键：`← / →`。
- 忽略应用：设置页用“选择应用…”按钮（`NSOpenPanel` 只允许选 `.app`），不提供手动输入。
- 忽略应用默认列表：**空**（MVP 不内置预设忽略列表，用户手动添加）。
- 技术路线：**SwiftUI 为主** + 必要 AppKit/Carbon 桥接（`MenuBarExtra` + 自定义 `NSPanel` + Carbon 全局热键）。
- 隐私策略（MVP）：**仅“忽略指定 App”**，不做按剪贴板类型/敏感内容的额外过滤（见“风险与缓解”）。
- 面板失焦行为：**点击外部/切换 App/失去焦点自动关闭**（类似 Spotlight 的“随用随走”）。

## 3. 总体架构

### 3.1 模块划分

- `HotkeyManager`
  - 注册/更新全局快捷键（默认 `⌘⇧V`），接收热键事件并转发给 `PanelController`。
- `ClipboardMonitor`
  - 轮询 `NSPasteboard.general.changeCount` 监听剪贴板变化；读取 `.string`；非文本直接忽略。
- `ClipboardStore`（SwiftData）
  - 负责持久化、限量、相邻去重、查询（按时间倒序）、清空。
- `IgnoreAppStore`
  - 保存被忽略的 `bundleIdentifier` 列表；提供增删查；供 `ClipboardMonitor` 判断是否跳过记录。
- `PanelController`
  - 管理居中 `NSPanel` 的显示/隐藏、焦点、分页状态、选中项、键盘事件分发。
- `PasteService`
  - 执行“粘贴动作”：写剪贴板 +（若授权）模拟 `⌘V`；否则降级并提示。

### 3.2 数据流（核心路径）

1) 剪贴板 changeCount 变化  
2) `ClipboardMonitor` 读取文本 → 若前台 App 在忽略列表则跳过 → 去重/限量策略由 `ClipboardStore` 执行并写入  
3) 用户按热键唤出面板 → `ClipboardStore` 查询最新记录分页展示  
4) 用户选择（`Enter`/`⌘1..5`）→ `PasteService` 执行粘贴动作 → 关闭面板

## 4. UI 与交互设计

### 4.1 菜单栏（`MenuBarExtra`）

建议菜单项（MVP）：

- `Open Clipboard Panel`（同热键行为）
- `Settings…`
- `Clear History`
- `Quit`

### 4.2 剪切板面板（居中 `NSPanel` + SwiftUI）

面板行为：

- 唤出：全局热键（默认 `⌘⇧V`）。若已显示则关闭（toggle）。
- 关闭：`Esc` 关闭；不粘贴。
- 失焦：点击面板外/切换 App/失去焦点自动关闭；不粘贴。
- 默认选中：打开时选中最新一条（第 1 条）。

列表与分页：

- 每页最多 5 条；最新在前（上方）。
- `← / →` 翻页；翻页后选中该页第 1 条。
- 显示页码提示，例如 `2/10`。

选择与粘贴：

- `↑ / ↓` 在当前页移动选中，到边界不循环。
- `Enter` 对当前选中项执行“粘贴动作”并关闭面板。
- `⌘ + 1..5`：直接粘贴当前页对应项并关闭；若序号不存在则不执行（可轻提示）。

空状态：

- 无历史时展示“暂无历史记录”，保留 `Esc`/`⌘,` 等按键行为一致。

### 4.3 “粘贴动作”定义（自动优先 + 降级）

1) 将目标文本写入系统剪贴板（`NSPasteboard.general`）。  
2) 检查「辅助功能/可访问性」是否授权：  
   - 已授权：用 `CGEvent` 模拟 `⌘V` 到当前前台 App。  
   - 未授权：不模拟按键，仅写入剪贴板，并在面板内提示“未开启辅助功能，已复制到剪贴板（可手动 `⌘V`）”，同时在设置页提供跳转按钮。

## 5. 设置（`⌘,`）与偏好项

### 5.1 打开规则

- 任意位置按 `⌘,` 打开设置窗口。
- 若剪切板面板当前打开：先关闭面板，再打开设置（互斥显示，满足 PRD FR-9）。

### 5.2 Tab 结构

- `通用 / 剪切板 / 关于`

### 5.3 通用

- 开机自启：开/关（建议使用 `SMAppService`，目标 macOS 14+）。
- 唤出面板快捷键：编辑/保存后即时生效；提供冲突风险提示（MVP 做轻提示即可）。

### 5.4 剪切板

- 最大历史条数：默认 200（可调）；变更后立即裁剪到最新 N 条。
- 去重策略：相邻去重开关（默认开启）。
- 忽略应用列表：
  - “选择应用…”：`NSOpenPanel` 仅选择 `.app`；读取其 `bundleIdentifier`；无 bundle id 或重复则提示。
  - 列表显示：图标 + 名称 + Bundle ID；支持删除。
  - 默认：列表为空（不预置任何 App）。
- 清空历史：二次确认；清空后面板立即反映为空状态。

### 5.5 关于

- App 名称、版本号（从 Bundle 读取）。
- 反馈/联系信息（MVP 可先放占位）。

### 5.6 隐私透明化（MVP）

- 在“剪切板”页用短文案说明：应用会读取剪贴板用于历史功能；提供限量/清空/忽略 App 控制项。
- 对“自动粘贴”额外说明需要开启「辅助功能/可访问性」权限，并提供跳转系统设置按钮。

## 6. 数据模型（MVP）

SwiftData 持久化（建议模型）：

- `ClipboardEntry`
  - `id: UUID`
  - `text: String`
  - `createdAt: Date`

偏好项（UserDefaults/SwiftData 均可，MVP 建议 UserDefaults）：

- `maxHistoryCount: Int`（默认 200）
- `dedupeAdjacentEnabled: Bool`（默认 true）
- `hotkey: { keyCode, modifiers }`
- `ignoredApps: [{ bundleIdentifier, appPath?, displayName? }]`

## 7. 错误处理与降级策略

- 读取到非文本剪贴板：忽略（不写入历史）。
- 模拟 `⌘V` 失败/前台不可输入：降级为“仅写入剪贴板”，并给轻提示。
- 未授权辅助功能：同上降级 + 引导开启权限（不阻塞用户继续使用）。
- 忽略 App 解析失败（无 bundle id）：提示并不加入列表。
- 日志：关键路径使用 `os.Logger` 记录（MVP 不做复杂日志面板）。

## 8. 测试策略（MVP）

单元测试优先覆盖纯逻辑：

- 去重：相邻去重开/关的行为。
- 限量裁剪：插入超过上限时只保留最新 N 条。
- 分页：总数/页数/索引映射；`⌘1..5` 对应项存在/不存在。
- 忽略列表：添加/删除/去重；前台 bundle id 命中时跳过记录。

手测验收清单（对应 PRD 7）：

- 热键唤出/`Esc` 关闭；默认选中新内容。
- 失焦自动关闭：点击外部/切换 App/失去焦点关闭且不粘贴；再次唤出正常。
- `↑/↓`、`Enter`、`⌘1..⌘5`、`←/→` 分页、页码显示。
- `⌘,` 从面板打开设置且面板关闭；设置 Tab 正确。
- 设置：改热键生效；改最大条数立即裁剪；清空立即生效；忽略 App 生效。
- 重启 App 后历史仍存在。

## 9. 实现优先级（建议）

1) 数据层：`ClipboardStore` + 去重/限量/清空  
2) 监听：`ClipboardMonitor` + 忽略 App 判定  
3) 面板：`NSPanel` + 列表/分页/键盘交互  
4) 全局热键：`HotkeyManager`（可配置）  
5) 粘贴：`PasteService` + 权限降级提示  
6) 设置：General/Clipboard/About + `⌘,` 行为  

## 10. 风险与缓解（MVP）

### 10.1 隐私风险：敏感内容被持久化

风险：MVP 仅支持“忽略指定 App”，若用户未将敏感 App 加入忽略列表，剪贴板文本可能被写入本地持久化历史（重启后仍存在）。

MVP 缓解（不扩展范围）：

- 设置页“剪切板”中强化透明化文案：说明会读取剪贴板并默认持久化；提示用户将密码/机密相关 App 加入忽略。
- 提供一键清空与可调“最大历史条数”，鼓励用户用更小的上限降低暴露面。
- 如后续用户反馈强烈，再评估加入“按剪贴板类型过滤”或“暂停记录/隐私模式”。
