# 富文本/图片剪贴板 Implementation Plan

> **For codex:** REQUIRED SUB-SKILL: Use superpowers-executing-plans to implement this plan task-by-task.

**Goal:** 为 Quicker 增加对 `NSPasteboard` 的 `RTF` 与图片历史采集、持久化、面板预览与一键粘贴能力（图片落盘，SwiftData 存路径）。

**Architecture:** 采集链路拆成“读取快照（主线程）→ 纯逻辑决策/处理（后台 Task）→ `@MainActor` 写入 SwiftData（含图片落盘/引用计数）”。UI 仍由现有面板驱动，但 entries 从 `String` 升级为 `ClipboardPanelEntry`，并为图片条目渲染缩略图。粘贴链路扩展 `PasteService` 支持 `.rtf/.image`，写回 `NSPasteboardItem` 并在授权时发送 `⌘V`。

**Tech Stack:** SwiftUI、AppKit（`NSPasteboard`）、SwiftData、ImageIO、UniformTypeIdentifiers、CryptoKit、CoreGraphics（`CGEvent`）、XCTest

---

## 0. 输入与验收标准（先读这些）

**需求/设计来源：**
- `docs/plans/2026-02-05-clipboard-rich-content-design.md`

**验收清单（实现过程中随时对照）：**
- 复制富文本（`NSPasteboard.PasteboardType.rtf`）会进入历史；面板预览显示纯文本；粘贴回目标 App 时优先恢复富文本，同时携带 `.string` 降级。
- 复制图片（优先 `.png`，其次 `.tiff`）会进入历史；SwiftData 仅存 `imagePath`；真实图片以 `<contentHash>.png` 落盘；面板显示缩略图 + 文本占位“图片”；粘贴回目标 App 时写 `.png`（可选补写 `.tiff`）。
- 隐私标记过滤：若 `NSPasteboardItem.types` 含 `org.nspasteboard.TransientType` / `org.nspasteboard.ConcealedType` / `org.nspasteboard.AutoGeneratedType`（或专有标记）则跳过记录。
- 多 item 策略：一次变更只生成 1 条历史；优先级 image > rtf > string；纯文本多 item 用 `"\n"` 拼接。
- 图片护栏：长边超过 `maxStoredImageMaxPixel` 则下采样；最终 `pngData.count > maxStoredImageBytes` 则跳过记录（不插入历史）。
- 清理一致性：`ClipboardStore.clear()` 与 `trimToMaxCount()` 删除条目时同步删除无引用图片文件。
- 权限降级：未授权辅助功能时，仅写剪贴板不模拟 `⌘V`，并 toast 提示（保持现有一致性）。

---

## 1. 一次性准备（不写业务代码）

> ⚠️ 规则：任何 Xcode 相关操作（list/build/test/clean）都必须使用 **xc-all MCP** 的 `xcode_list` / `xcode_build` / `xcode_test` / `xcode_clean`；不要在 bash 里直接运行 `xcodebuild`。

1) 确认 scheme

Invoke（xc-all MCP / `xcode_list`）:
```json
{
  "project_path": "quicker.xcodeproj"
}
```

Expected:
- `schemes` 包含 `quicker`

2) 做一次测试 smoke（确保后续每个“Run test”步骤都能跑）

Invoke（xc-all MCP / `xcode_test`）:
```json
{
  "project_path": "quicker.xcodeproj",
  "scheme": "quicker",
  "destination": "platform=macOS,name=Any Mac",
  "only_testing": ["quickerTests/ClipboardStoreTests/testInsertAndFetchLatest"]
}
```

Expected:
- PASS

若失败并提示 destination 不匹配：改用 `platform=macOS,name=My Mac`（或 `arch=arm64` 的 My Mac 条目）重试。

---

### spawn_agent 1: `ContentHash`（SHA256 hex）

**Files:**
- Create: `quicker/Clipboard/ContentHash.swift`
- Test: `quickerTests/ContentHashTests.swift`

**Step 1: Write the failing test**

Create `quickerTests/ContentHashTests.swift`:
```swift
import Foundation
import XCTest
@testable import quicker

final class ContentHashTests: XCTestCase {
    func testSha256HexForData() {
        let data = Data("A".utf8)
        XCTAssertEqual(
            ContentHash.sha256Hex(data),
            "559aead08264d5795d3909718cdd05abd49572e84fe55590eef31a88a08fdffd"
        )
    }
}
```

**Step 2: Run test to verify it fails**

Invoke（xc-all MCP / `xcode_test`）:
```json
{
  "project_path": "quicker.xcodeproj",
  "scheme": "quicker",
  "destination": "platform=macOS,name=Any Mac",
  "only_testing": ["quickerTests/ContentHashTests/testSha256HexForData"]
}
```

Expected: FAIL（`Cannot find 'ContentHash' in scope`）

**Step 3: Write minimal implementation**

Create `quicker/Clipboard/ContentHash.swift`:
```swift
import CryptoKit
import Foundation

enum ContentHash {
    static func sha256Hex(_ data: Data) -> String {
        let digest = SHA256.hash(data: data)
        return digest.map { String(format: "%02x", $0) }.joined()
    }
}
```

**Step 4: Run test to verify it passes**

Re-run the same `xcode_test`.

Expected: PASS

**Step 5: Commit**

```bash
git add quicker/Clipboard/ContentHash.swift quickerTests/ContentHashTests.swift
git commit -m "feat(clipboard): 新增内容哈希工具"
```

---

### spawn_agent 2: `ClipboardEntryKind` + 扩展 `ClipboardEntry`（轻量迁移）

**Files:**
- Create: `quicker/Clipboard/ClipboardEntryKind.swift`
- Modify: `quicker/Clipboard/ClipboardEntry.swift`
- Test: `quickerTests/ClipboardEntryKindTests.swift`

**Step 1: Write the failing test**

Create `quickerTests/ClipboardEntryKindTests.swift`:
```swift
import XCTest
@testable import quicker

final class ClipboardEntryKindTests: XCTestCase {
    func testParsesRaw() {
        XCTAssertEqual(ClipboardEntryKind(raw: nil), .text)
        XCTAssertEqual(ClipboardEntryKind(raw: "text"), .text)
        XCTAssertEqual(ClipboardEntryKind(raw: "rtf"), .rtf)
        XCTAssertEqual(ClipboardEntryKind(raw: "image"), .image)
        XCTAssertEqual(ClipboardEntryKind(raw: "unknown"), .text)
    }
}
```

**Step 2: Run test to verify it fails**

Invoke（xc-all MCP / `xcode_test`）:
```json
{
  "project_path": "quicker.xcodeproj",
  "scheme": "quicker",
  "destination": "platform=macOS,name=Any Mac",
  "only_testing": ["quickerTests/ClipboardEntryKindTests/testParsesRaw"]
}
```

Expected: FAIL（`Cannot find 'ClipboardEntryKind' in scope`）

**Step 3: Write minimal implementation**

Create `quicker/Clipboard/ClipboardEntryKind.swift`:
```swift
import Foundation

enum ClipboardEntryKind: String, Equatable {
    case text
    case rtf
    case image

    init(raw: String?) {
        self = ClipboardEntryKind(rawValue: raw ?? "") ?? .text
    }
}
```

Modify `quicker/Clipboard/ClipboardEntry.swift`（新增字段均为可选，便于 SwiftData 轻量迁移）:
```swift
import Foundation
import SwiftData

@Model
final class ClipboardEntry {
    var text: String
    var createdAt: Date

    var kindRaw: String?
    var rtfData: Data?
    var imagePath: String?
    var contentHash: String?

    init(text: String, createdAt: Date = .now) {
        self.text = text
        self.createdAt = createdAt
    }
}
```

**Step 4: Run test to verify it passes**

Re-run the same `xcode_test`.

Expected: PASS

**Step 5: Commit**

```bash
git add quicker/Clipboard/ClipboardEntryKind.swift quicker/Clipboard/ClipboardEntry.swift quickerTests/ClipboardEntryKindTests.swift
git commit -m "feat(clipboard): 扩展 ClipboardEntry 支持多类型"
```

---

### spawn_agent 3: `ClipboardAssetStore`（图片落盘）+ 单测

**Files:**
- Create: `quicker/Clipboard/ClipboardAssetStore.swift`
- Test: `quickerTests/ClipboardAssetStoreTests.swift`

**Step 1: Write the failing test**

Create `quickerTests/ClipboardAssetStoreTests.swift`:
```swift
import Foundation
import XCTest
@testable import quicker

final class ClipboardAssetStoreTests: XCTestCase {
    func testSaveLoadDelete() throws {
        let baseURL = FileManager.default.temporaryDirectory
            .appendingPathComponent(UUID().uuidString, isDirectory: true)
        let store = ClipboardAssetStore(baseURL: baseURL)

        let data = Data([0x01, 0x02, 0x03])
        let rel = try store.saveImage(pngData: data, contentHash: "hash")
        XCTAssertTrue(rel.hasSuffix("hash.png"))

        let loaded = try store.loadImageData(relativePath: rel)
        XCTAssertEqual(loaded, data)

        try store.deleteImage(relativePath: rel)
        XCTAssertFalse(FileManager.default.fileExists(atPath: store.fileURL(relativePath: rel).path))
    }
}
```

**Step 2: Run test to verify it fails**

Invoke（xc-all MCP / `xcode_test`）:
```json
{
  "project_path": "quicker.xcodeproj",
  "scheme": "quicker",
  "destination": "platform=macOS,name=Any Mac",
  "only_testing": ["quickerTests/ClipboardAssetStoreTests/testSaveLoadDelete"]
}
```

Expected: FAIL（`Cannot find 'ClipboardAssetStore' in scope`）

**Step 3: Write minimal implementation**

Create `quicker/Clipboard/ClipboardAssetStore.swift`:
```swift
import Foundation

protocol ClipboardAssetStoring {
    func saveImage(pngData: Data, contentHash: String) throws -> String
    func loadImageData(relativePath: String) throws -> Data
    func deleteImage(relativePath: String) throws
    func fileURL(relativePath: String) -> URL
}

struct ClipboardAssetStore: ClipboardAssetStoring {
    private let baseURL: URL

    init(baseURL: URL = ClipboardAssetStore.defaultBaseURL()) {
        self.baseURL = baseURL
    }

    static func defaultBaseURL() -> URL {
        let fm = FileManager.default
        let appSupport = try! fm.url(
            for: .applicationSupportDirectory,
            in: .userDomainMask,
            appropriateFor: nil,
            create: true
        )
        let bundleId = Bundle.main.bundleIdentifier ?? "quicker"
        return appSupport
            .appendingPathComponent(bundleId, isDirectory: true)
            .appendingPathComponent("clipboard-assets", isDirectory: true)
    }

    private func ensureBaseDir() throws {
        try FileManager.default.createDirectory(
            at: baseURL,
            withIntermediateDirectories: true
        )
    }

    func fileURL(relativePath: String) -> URL {
        baseURL.appendingPathComponent(relativePath, isDirectory: false)
    }

    func saveImage(pngData: Data, contentHash: String) throws -> String {
        try ensureBaseDir()
        let rel = "\(contentHash).png"
        try pngData.write(to: fileURL(relativePath: rel), options: .atomic)
        return rel
    }

    func loadImageData(relativePath: String) throws -> Data {
        try Data(contentsOf: fileURL(relativePath: relativePath))
    }

    func deleteImage(relativePath: String) throws {
        let url = fileURL(relativePath: relativePath)
        if FileManager.default.fileExists(atPath: url.path) {
            try FileManager.default.removeItem(at: url)
        }
    }
}
```

**Step 4: Run test to verify it passes**

Re-run the same `xcode_test`.

Expected: PASS

**Step 5: Commit**

```bash
git add quicker/Clipboard/ClipboardAssetStore.swift quickerTests/ClipboardAssetStoreTests.swift
git commit -m "feat(clipboard): 新增图片资产落盘模块"
```

---

### spawn_agent 4: `PasteboardSnapshot` + `PasteboardCaptureLogic`（纯逻辑，可测）

**Files:**
- Create: `quicker/Clipboard/PasteboardSnapshot.swift`
- Create: `quicker/Clipboard/PasteboardCaptureLogic.swift`
- Test: `quickerTests/PasteboardCaptureLogicTests.swift`

**Step 1: Write the failing test**

Create `quickerTests/PasteboardCaptureLogicTests.swift`:
```swift
import Foundation
import XCTest
@testable import quicker

final class PasteboardCaptureLogicTests: XCTestCase {
    func testSkipsWhenTransientMarkerPresent() {
        let snapshot = PasteboardSnapshot(items: [
            .init(typeIdentifiers: ["org.nspasteboard.TransientType"], pngData: nil, tiffData: nil, rtfData: nil, string: "A")
        ])
        XCTAssertNil(PasteboardCaptureLogic().capture(snapshot: snapshot))
    }

    func testPriorityImageOverRtfOverString() throws {
        let png = try XCTUnwrap(Data(base64Encoded: "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO7+5S8AAAAASUVORK5CYII="))
        let rtf = Data("{\\rtf1\\ansi hello}".utf8)

        let snapshot = PasteboardSnapshot(items: [
            .init(typeIdentifiers: ["public.rtf", "public.png"], pngData: png, tiffData: nil, rtfData: rtf, string: "fallback")
        ])

        let captured = try XCTUnwrap(PasteboardCaptureLogic().capture(snapshot: snapshot))
        XCTAssertEqual(captured.kind, .image)
        XCTAssertEqual(captured.contentHash, ContentHash.sha256Hex(png))
    }

    func testMultipleStringItemsJoinsWithNewline() throws {
        let snapshot = PasteboardSnapshot(items: [
            .init(typeIdentifiers: ["public.utf8-plain-text"], pngData: nil, tiffData: nil, rtfData: nil, string: "A"),
            .init(typeIdentifiers: ["public.utf8-plain-text"], pngData: nil, tiffData: nil, rtfData: nil, string: "B")
        ])
        let captured = try XCTUnwrap(PasteboardCaptureLogic().capture(snapshot: snapshot))
        XCTAssertEqual(captured.kind, .text)
        XCTAssertEqual(captured.plainText, "A\nB")
    }
}
```

**Step 2: Run test to verify it fails**

Invoke（xc-all MCP / `xcode_test`）:
```json
{
  "project_path": "quicker.xcodeproj",
  "scheme": "quicker",
  "destination": "platform=macOS,name=Any Mac",
  "only_testing": ["quickerTests/PasteboardCaptureLogicTests"]
}
```

Expected: FAIL（缺少 `PasteboardSnapshot` / `PasteboardCaptureLogic`）

**Step 3: Write minimal implementation**

Create `quicker/Clipboard/PasteboardSnapshot.swift`:
```swift
import Foundation

struct PasteboardSnapshot: Equatable {
    struct Item: Equatable {
        let typeIdentifiers: [String]
        let pngData: Data?
        let tiffData: Data?
        let rtfData: Data?
        let string: String?
    }

    let items: [Item]
}
```

Create `quicker/Clipboard/PasteboardCaptureLogic.swift`（先实现：隐私标记过滤 + 优先级 + 多文本 join + 计算 hash；TIFF 转 PNG、像素护栏下一步再加）:
```swift
import Foundation

struct CapturedClipboardContent: Equatable {
    let kind: ClipboardEntryKind
    let plainText: String
    let rtfData: Data?
    let pngData: Data?
    let contentHash: String
}

struct PasteboardCaptureLogic {
    private let markerTypeIdentifiers: Set<String> = [
        "org.nspasteboard.TransientType",
        "org.nspasteboard.ConcealedType",
        "org.nspasteboard.AutoGeneratedType",
        "com.agilebits.onepassword",
        "de.petermaurer.TransientPasteboardType"
    ]

    func capture(snapshot: PasteboardSnapshot) -> CapturedClipboardContent? {
        guard snapshot.items.isEmpty == false else { return nil }

        if snapshot.items.contains(where: { item in item.typeIdentifiers.contains(where: markerTypeIdentifiers.contains) }) {
            return nil
        }

        if let item = snapshot.items.first(where: { $0.pngData != nil || $0.tiffData != nil }) {
            if let png = item.pngData {
                return CapturedClipboardContent(
                    kind: .image,
                    plainText: "图片",
                    rtfData: nil,
                    pngData: png,
                    contentHash: ContentHash.sha256Hex(png)
                )
            }
            // TIFF->PNG 在下一步补齐（先返回 nil，确保测试能驱动你加实现）
        }

        if let item = snapshot.items.first(where: { $0.rtfData != nil }), let rtf = item.rtfData {
            return CapturedClipboardContent(
                kind: .rtf,
                plainText: item.string?.trimmingCharacters(in: .whitespacesAndNewlines) ?? "",
                rtfData: rtf,
                pngData: nil,
                contentHash: ContentHash.sha256Hex(rtf)
            )
        }

        let strings = snapshot.items.compactMap(\.string).map { $0.trimmingCharacters(in: .whitespacesAndNewlines) }.filter { !$0.isEmpty }
        guard strings.isEmpty == false else { return nil }
        let joined = strings.joined(separator: "\n")
        let hash = ContentHash.sha256Hex(Data(joined.utf8))
        return CapturedClipboardContent(kind: .text, plainText: joined, rtfData: nil, pngData: nil, contentHash: hash)
    }
}
```

**Step 4: Run test to verify it passes**

Re-run the same `xcode_test`.

Expected:
- `testSkipsWhenTransientMarkerPresent` PASS
- `testPriorityImageOverRtfOverString` PASS
- `testMultipleStringItemsJoinsWithNewline` PASS

**Step 5: Commit**

```bash
git add quicker/Clipboard/PasteboardSnapshot.swift quicker/Clipboard/PasteboardCaptureLogic.swift quickerTests/PasteboardCaptureLogicTests.swift
git commit -m "feat(clipboard): 新增剪贴板采集纯逻辑"
```

---

### spawn_agent 5: TIFF→PNG（ImageIO）+ 图片护栏（像素/字节）

**Files:**
- Modify: `quicker/Clipboard/PasteboardCaptureLogic.swift`
- Test: `quickerTests/PasteboardCaptureLogicImageTests.swift`

**Step 1: Write the failing test**

Create `quickerTests/PasteboardCaptureLogicImageTests.swift`:
```swift
import Foundation
import XCTest
@testable import quicker

final class PasteboardCaptureLogicImageTests: XCTestCase {
    func testDownsamplesWhenMaxPixelExceeded() throws {
        // 生成一个 100x50 的 TIFF 数据
        let tiff = try TestImageFactory.makeTIFF(width: 100, height: 50)

        let snapshot = PasteboardSnapshot(items: [
            .init(typeIdentifiers: ["public.tiff"], pngData: nil, tiffData: tiff, rtfData: nil, string: nil)
        ])

        var logic = PasteboardCaptureLogic()
        logic.maxStoredImageMaxPixel = 40
        logic.maxStoredImageBytes = 1024 * 1024

        let captured = try XCTUnwrap(logic.capture(snapshot: snapshot))
        XCTAssertEqual(captured.kind, .image)

        let png = try XCTUnwrap(captured.pngData)
        let size = try TestImageFactory.imagePixelSize(pngData: png)
        XCTAssertLessThanOrEqual(max(size.width, size.height), 40)
    }

    func testSkipsWhenPngBytesExceedLimit() throws {
        let huge = Data(repeating: 0x01, count: 10)
        var logic = PasteboardCaptureLogic()
        logic.maxStoredImageBytes = 5
        logic.maxStoredImageMaxPixel = 4096

        let snapshot = PasteboardSnapshot(items: [
            .init(typeIdentifiers: ["public.png"], pngData: huge, tiffData: nil, rtfData: nil, string: nil)
        ])
        XCTAssertNil(logic.capture(snapshot: snapshot))
    }
}

enum TestImageFactory {
    static func makeTIFF(width: Int, height: Int) throws -> Data {
        // 实现放在 Step 3（先让测试驱动你写 ImageIO 编码）
        return Data()
    }

    static func imagePixelSize(pngData: Data) throws -> (width: Int, height: Int) {
        return (0, 0)
    }
}
```

**Step 2: Run test to verify it fails**

Invoke（xc-all MCP / `xcode_test`）:
```json
{
  "project_path": "quicker.xcodeproj",
  "scheme": "quicker",
  "destination": "platform=macOS,name=Any Mac",
  "only_testing": ["quickerTests/PasteboardCaptureLogicImageTests"]
}
```

Expected: FAIL（测试 helper 为空实现 / `PasteboardCaptureLogic` 不支持 TIFF / 不支持 limits）

**Step 3: Write minimal implementation**

1) 在 `quicker/Clipboard/PasteboardCaptureLogic.swift` 增加可调护栏参数（默认值先硬编码）：
```swift
import ImageIO
import UniformTypeIdentifiers

struct PasteboardCaptureLogic {
    var maxStoredImageBytes: Int = 20 * 1024 * 1024
    var maxStoredImageMaxPixel: Int = 4096
    // ...
}
```

2) 增加 ImageIO 工具函数（放在同文件里即可，先不做额外抽象）：
```swift
private enum ImageIOConvert {
    static func pixelSize(data: Data) -> (width: Int, height: Int)? {
        guard let src = CGImageSourceCreateWithData(data as CFData, nil) else { return nil }
        guard let props = CGImageSourceCopyPropertiesAtIndex(src, 0, nil) as? [CFString: Any] else { return nil }
        let w = props[kCGImagePropertyPixelWidth] as? Int ?? 0
        let h = props[kCGImagePropertyPixelHeight] as? Int ?? 0
        guard w > 0, h > 0 else { return nil }
        return (w, h)
    }

    static func makePNG(from imageData: Data, maxPixel: Int) -> Data? {
        guard let src = CGImageSourceCreateWithData(imageData as CFData, nil) else { return nil }

        let thumbOpts: [CFString: Any] = [
            kCGImageSourceCreateThumbnailWithTransform: true,
            kCGImageSourceCreateThumbnailFromImageAlways: true,
            kCGImageSourceThumbnailMaxPixelSize: maxPixel
        ]

        let img = CGImageSourceCreateThumbnailAtIndex(src, 0, thumbOpts as CFDictionary)
            ?? CGImageSourceCreateImageAtIndex(src, 0, nil)
        guard let img else { return nil }

        let out = NSMutableData()
        guard let dest = CGImageDestinationCreateWithData(out, UTType.png.identifier as CFString, 1, nil) else { return nil }
        CGImageDestinationAddImage(dest, img, nil)
        guard CGImageDestinationFinalize(dest) else { return nil }
        return out as Data
    }
}
```

3) 修改 `capture(snapshot:)` 的图片分支：
 - 先做字节上限快速拦截（`pngData.count > maxStoredImageBytes` 直接返回 `nil`）
 - `.png`：若像素超限则走 `ImageIOConvert.makePNG(from: png, maxPixel: maxStoredImageMaxPixel)`
 - `.tiff`：直接走 `ImageIOConvert.makePNG(from: tiff, maxPixel: maxStoredImageMaxPixel)`
 - 生成最终 `pngData` 后再次检查字节上限；超限则 `nil`

4) 补齐测试 helper（同文件 `quickerTests/PasteboardCaptureLogicImageTests.swift`）：
 - `makeTIFF(width:height:)`：用 `CGContext` 画一个纯色 `CGImage`，再用 `CGImageDestination` + `UTType.tiff.identifier` 编码为 `Data`
 - `imagePixelSize(pngData:)`：用 `CGImageSourceCopyPropertiesAtIndex` 读取宽高

**Step 4: Run test to verify it passes**

Re-run the same `xcode_test`.

Expected: PASS

**Step 5: Commit**

```bash
git add quicker/Clipboard/PasteboardCaptureLogic.swift quickerTests/PasteboardCaptureLogicImageTests.swift
git commit -m "feat(clipboard): 新增图片下采样与大小护栏"
```

---

### spawn_agent 6: `ClipboardStore` 支持多类型插入 + 图片引用删除

**Files:**
- Modify: `quicker/Clipboard/ClipboardStore.swift`
- Modify: `quickerTests/ClipboardStoreTests.swift`
- Create: `quickerTests/ClipboardStoreImageTests.swift`

**Step 1: Write the failing test**

1) 在 `quickerTests/ClipboardStoreTests.swift` 增加断言：插入文本会写入 `kindRaw == "text"` 且 `contentHash != nil`（若你已提前写过类似测试，可直接使用并确保它真的会 fail）。

示例（使用 Mirror 避免在字段未加之前编译错误）：
```swift
func testInsertSetsKindAndContentHashForText() throws {
    let container = try makeInMemoryContainer()
    let store = ClipboardStore(
        modelContainer: container,
        preferences: PreferencesStore(userDefaults: UserDefaults(suiteName: UUID().uuidString)!)
    )

    _ = try store.insert(text: "A")

    let entry = try XCTUnwrap(store.fetchLatest(limit: 1).first)
    XCTAssertEqual(mirrorOptionalString(entry, label: "kindRaw"), "text")
    XCTAssertNotNil(mirrorOptionalString(entry, label: "contentHash"))
}
```

2) 新增图片裁剪/清理测试 `quickerTests/ClipboardStoreImageTests.swift`：
```swift
import Foundation
import SwiftData
import XCTest
@testable import quicker

@MainActor
final class ClipboardStoreImageTests: XCTestCase {
    func testClearDeletesUnreferencedImageFiles() throws {
        let schema = Schema([ClipboardEntry.self])
        let config = ModelConfiguration(schema: schema, isStoredInMemoryOnly: true)
        let container = try ModelContainer(for: schema, configurations: [config])

        let baseURL = FileManager.default.temporaryDirectory
            .appendingPathComponent(UUID().uuidString, isDirectory: true)
        let assets = ClipboardAssetStore(baseURL: baseURL)

        let prefs = PreferencesStore(userDefaults: UserDefaults(suiteName: UUID().uuidString)!)
        let store = ClipboardStore(modelContainer: container, preferences: prefs, assetStore: assets)

        let png = Data([0x01, 0x02])
        let hash = ContentHash.sha256Hex(png)
        let rel = try assets.saveImage(pngData: png, contentHash: hash)

        let entry = ClipboardEntry(text: "图片")
        entry.kindRaw = "image"
        entry.imagePath = rel
        entry.contentHash = hash
        container.mainContext.insert(entry)
        try container.mainContext.save()

        try store.clear()
        XCTAssertFalse(FileManager.default.fileExists(atPath: assets.fileURL(relativePath: rel).path))
    }
}
```

**Step 2: Run test to verify it fails**

Invoke（xc-all MCP / `xcode_test`）:
```json
{
  "project_path": "quicker.xcodeproj",
  "scheme": "quicker",
  "destination": "platform=macOS,name=Any Mac",
  "only_testing": ["quickerTests/ClipboardStoreTests/testInsertSetsKindAndContentHashForText", "quickerTests/ClipboardStoreImageTests/testClearDeletesUnreferencedImageFiles"]
}
```

Expected: FAIL（`ClipboardStore` 尚未写入 `kindRaw/contentHash`；`clear()` 尚未删除图片文件；`ClipboardStore` init 不支持注入 `assetStore`）

**Step 3: Write minimal implementation**

1) 修改 `quicker/Clipboard/ClipboardStore.swift` 支持注入 `assetStore`：
```swift
@MainActor
final class ClipboardStore {
    private let modelContainer: ModelContainer
    private let preferences: PreferencesStore
    private let assetStore: ClipboardAssetStoring

    init(modelContainer: ModelContainer, preferences: PreferencesStore, assetStore: ClipboardAssetStoring = ClipboardAssetStore()) {
        self.modelContainer = modelContainer
        self.preferences = preferences
        self.assetStore = assetStore
    }
    // ...
}
```

2) 在 `insert(text:)` 内设置：
 - `kindRaw = "text"`
 - `contentHash = ContentHash.sha256Hex(Data(trimmed.utf8))`
 - 相邻去重改为对比 `kindRaw + contentHash`（注意：旧数据可能为 nil，按 `.text` 处理）

3) 在 `clear()` / `trimToMaxCount()` 删除条目前：
 - 若 `entry.kindRaw == "image"` 且 `imagePath != nil`：先检查是否仍有其他条目引用该 `imagePath`（查询 SwiftData），若无引用则 `assetStore.deleteImage(relativePath:)`

**Step 4: Run test to verify it passes**

Re-run同一组 `xcode_test`。

Expected: PASS

**Step 5: Commit**

```bash
git add quicker/Clipboard/ClipboardStore.swift quickerTests/ClipboardStoreTests.swift quickerTests/ClipboardStoreImageTests.swift
git commit -m "feat(clipboard): 支持多类型去重并清理图片文件"
```

---

### spawn_agent 7: `SystemPasteboardClient` 读取快照 + `ClipboardMonitor` 接入采集逻辑

**Files:**
- Modify: `quicker/Clipboard/PasteboardClient.swift`
- Modify: `quicker/Clipboard/ClipboardMonitor.swift`
- Modify: `quicker/App/AppState.swift`

**Step 1: Write the failing test**

这一段偏系统集成，单测价值不高（`NSPasteboard` 不易在单测中可靠构造）。用“手动验证”替代：

手测步骤（开发期）：
- 启动 App，复制一段富文本 / 一张图片
- 观察 SwiftData 是否新增一条 `ClipboardEntry`，且 `kindRaw`/`rtfData`/`imagePath`/`contentHash` 字段符合预期

**Step 2: Run test to verify it fails**

跳过（用手测替代）。

**Step 3: Write minimal implementation**

1) 修改 `quicker/Clipboard/PasteboardClient.swift`：
- `readString()` → `readSnapshot() -> PasteboardSnapshot?`
- `SystemPasteboardClient.readSnapshot()`：
  - 读取 `NSPasteboard.general.pasteboardItems`
  - 对每个 item：
    - `types.map(\.rawValue)` 填 `typeIdentifiers`
    - 读取 `.png` / `.tiff` / `.rtf` / `.string`（不存在则 nil）
  - 返回 `PasteboardSnapshot(items:)`

2) 修改 `quicker/Clipboard/ClipboardMonitor.swift`：
- 由 `readSnapshot()` 获取快照
- 调用 `PasteboardCaptureLogic().capture(snapshot:)`
- 若捕获到 `CapturedClipboardContent`：
  - 复用现有 `ClipboardMonitorLogic` 的 ignore 判断（仍以 `frontmostBundleId` 为准）
  - 根据 `captured.kind`：
    - `.text`：调用 `clipboardStore.insert(text:)`（已改为写入 `kindRaw/contentHash`）
    - `.rtf`：新增 `clipboardStore.insert(rtfData:plainText:hash:)`（见下一 spawn_agent）
    - `.image`：新增 `clipboardStore.insert(pngData:hash:)`（见下一 spawn_agent）

3) 修改 `quicker/App/AppState.swift`：保持 monitor init 结构不变，但 pasteboard client 类型适配后要更新构造参数。

**Step 4: Run test to verify it passes**

做一次 smoke：
- Invoke（xc-all MCP / `xcode_test`）跑现有 `ClipboardStoreTests`（确保改动没把纯文本路径弄崩）

**Step 5: Commit**

```bash
git add quicker/Clipboard/PasteboardClient.swift quicker/Clipboard/ClipboardMonitor.swift quicker/App/AppState.swift
git commit -m "feat(clipboard): 接入剪贴板快照采集"
```

---

### spawn_agent 8: `ClipboardStore` 插入 `.rtf` / `.image`

**Files:**
- Modify: `quicker/Clipboard/ClipboardStore.swift`
- Create: `quickerTests/ClipboardStoreRtfTests.swift`
- Modify: `quickerTests/ClipboardStoreImageTests.swift`

**Step 1: Write the failing test**

Create `quickerTests/ClipboardStoreRtfTests.swift`:
```swift
import Foundation
import SwiftData
import XCTest
@testable import quicker

@MainActor
final class ClipboardStoreRtfTests: XCTestCase {
    func testInsertRtfSetsFields() throws {
        let schema = Schema([ClipboardEntry.self])
        let config = ModelConfiguration(schema: schema, isStoredInMemoryOnly: true)
        let container = try ModelContainer(for: schema, configurations: [config])

        let prefs = PreferencesStore(userDefaults: UserDefaults(suiteName: UUID().uuidString)!)
        let store = ClipboardStore(modelContainer: container, preferences: prefs, assetStore: ClipboardAssetStore(baseURL: FileManager.default.temporaryDirectory.appendingPathComponent(UUID().uuidString, isDirectory: true)))

        let rtf = Data("{\\rtf1\\ansi hello}".utf8)
        let hash = ContentHash.sha256Hex(rtf)

        _ = try store.insertRTF(rtfData: rtf, plainText: "hello", contentHash: hash)

        let entry = try XCTUnwrap(store.fetchLatest(limit: 1).first)
        XCTAssertEqual(entry.kindRaw, "rtf")
        XCTAssertEqual(entry.text, "hello")
        XCTAssertEqual(entry.rtfData, rtf)
        XCTAssertEqual(entry.contentHash, hash)
    }
}
```

在 `quickerTests/ClipboardStoreImageTests.swift` 增加一条插入图片的测试：
```swift
func testInsertImagePersistsPath() throws {
    // 同 testClear... 的初始化方式
    // 调用 store.insertImage(pngData:contentHash:)
    // 断言 entry.kindRaw == "image" 且 imagePath 非空，且文件存在
}
```

**Step 2: Run test to verify it fails**

Invoke（xc-all MCP / `xcode_test`）:
```json
{
  "project_path": "quicker.xcodeproj",
  "scheme": "quicker",
  "destination": "platform=macOS,name=Any Mac",
  "only_testing": ["quickerTests/ClipboardStoreRtfTests", "quickerTests/ClipboardStoreImageTests"]
}
```

Expected: FAIL（缺少 `insertRTF` / `insertImage`）

**Step 3: Write minimal implementation**

在 `quicker/Clipboard/ClipboardStore.swift` 新增：
- `insertRTF(rtfData:plainText:contentHash:) -> Bool`
  - trim `plainText`
  - `kindRaw = "rtf"`, `rtfData = rtfData`, `text = trimmed`, `contentHash = contentHash`
  - 相邻去重同样用 `kindRaw + contentHash`
  - 保存后走 `trimToMaxCount()`
- `insertImage(pngData:contentHash:) -> Bool`
  - 先 `assetStore.saveImage(...) -> relPath`
  - 插入条目：`kindRaw = "image"`, `text = "图片"`, `imagePath = relPath`, `contentHash = contentHash`
  - 保存后 `trimToMaxCount()`

**Step 4: Run test to verify it passes**

Re-run同一组 `xcode_test`。

Expected: PASS

**Step 5: Commit**

```bash
git add quicker/Clipboard/ClipboardStore.swift quickerTests/ClipboardStoreRtfTests.swift quickerTests/ClipboardStoreImageTests.swift
git commit -m "feat(clipboard): 新增 rtf 与图片条目插入"
```

---

### spawn_agent 9: `PasteboardWriting` 支持 `.rtf/.png` + `PasteService.paste(entry:)`

**Files:**
- Modify: `quicker/Paste/SystemPasteboardWriter.swift`
- Modify: `quicker/Paste/PasteService.swift`
- Test: `quickerTests/PasteServiceLogicTests.swift`

**Step 1: Write the failing test**

在 `quickerTests/PasteServiceLogicTests.swift` 增加：
```swift
func testWritesRtfAndStringWhenPastingRtfEntry() {
    let writer = SpyPasteboardWriter()
    let events = SpyPasteEventSender()
    let permission = FakeAccessibilityPermission(isTrusted: true)
    let service = PasteService(writer: writer, eventSender: events, permission: permission, assetStore: FakeAssetStore())

    let entry = ClipboardEntry(text: "hello")
    entry.kindRaw = "rtf"
    entry.rtfData = Data("{\\rtf1\\ansi hello}".utf8)

    _ = service.paste(entry: entry)
    XCTAssertEqual(writer.writtenKinds, ["rtf"])
    XCTAssertEqual(events.sentCount, 1)
}
```

（Spy 需要升级：记录写入的 kind；`FakeAssetStore` 仅为编译通过。）

**Step 2: Run test to verify it fails**

Invoke（xc-all MCP / `xcode_test`）:
```json
{
  "project_path": "quicker.xcodeproj",
  "scheme": "quicker",
  "destination": "platform=macOS,name=Any Mac",
  "only_testing": ["quickerTests/PasteServiceLogicTests"]
}
```

Expected: FAIL（缺少 `paste(entry:)` / writer 不支持 rtf/png）

**Step 3: Write minimal implementation**

1) 修改 `quicker/Paste/SystemPasteboardWriter.swift`：
- `PasteboardWriting` 增加：
  - `writeRTF(_ rtf: Data, plainText: String)`
  - `writePNG(_ png: Data)`
- `SystemPasteboardWriter` 用 `NSPasteboardItem` 写入多个 representation：
  - RTF：`item.setData(rtf, forType: .rtf)` + `item.setString(plainText, forType: .string)`
  - PNG：`item.setData(png, forType: .png)`
  - `pb.clearContents()` + `pb.writeObjects([item])`

2) 修改 `quicker/Paste/PasteService.swift`：
- 新增 `assetStore: ClipboardAssetStoring`
- 新增 `paste(entry: ClipboardEntry) -> PasteResult`：
  - `ClipboardEntryKind(raw: entry.kindRaw)` 分支处理
  - `.text`：复用现有逻辑
  - `.rtf`：若 `rtfData != nil` 则 `writer.writeRTF(...)`，否则回退 `.text`
  - `.image`：若 `imagePath != nil` 且 `assetStore.loadImageData(...)` 成功，则 `writer.writePNG(...)`，否则回退 `.copiedOnly` + toast（toast 仍由上层 AppState 做）

3) 更新测试 spy：
- `SpyPasteboardWriter` 新增 `writtenKinds: [String]`

**Step 4: Run test to verify it passes**

Re-run `PasteServiceLogicTests`。

Expected: PASS

**Step 5: Commit**

```bash
git add quicker/Paste/SystemPasteboardWriter.swift quicker/Paste/PasteService.swift quickerTests/PasteServiceLogicTests.swift
git commit -m "feat(paste): 支持粘贴 rtf 与图片"
```

---

### spawn_agent 10: 面板 UI：`ClipboardPanelEntry` + 图片缩略图

**Files:**
- Create: `quicker/Panel/ClipboardPanelEntry.swift`
- Modify: `quicker/Panel/ClipboardPanelViewModel.swift`
- Modify: `quicker/Panel/ClipboardPanelView.swift`
- Modify: `quicker/App/AppState.swift`

**Step 1: Write the failing test**

先覆盖 ViewModel 的“选中/分页/⌘1..5 映射”不回归（纯逻辑，适合单测）：

Create `quickerTests/ClipboardPanelViewModelRichTests.swift`:
```swift
import XCTest
@testable import quicker

@MainActor
final class ClipboardPanelViewModelRichTests: XCTestCase {
    func testSelectionAndCmdNumberWorksWithEntries() {
        let vm = ClipboardPanelViewModel(pageSize: 5)
        vm.setEntries((0..<6).map { ClipboardPanelEntry(kind: .text, previewText: "\($0)", rtfData: nil, imagePath: nil) })
        XCTAssertEqual(vm.selectedEntry?.previewText, "0")
        XCTAssertEqual(vm.entryForCmdNumber(1)?.previewText, "0")
        vm.nextPage()
        XCTAssertEqual(vm.selectedEntry?.previewText, "5")
    }
}
```

**Step 2: Run test to verify it fails**

Invoke（xc-all MCP / `xcode_test`）:
```json
{
  "project_path": "quicker.xcodeproj",
  "scheme": "quicker",
  "destination": "platform=macOS,name=Any Mac",
  "only_testing": ["quickerTests/ClipboardPanelViewModelRichTests"]
}
```

Expected: FAIL（缺少 `ClipboardPanelEntry` / VM API 不匹配）

**Step 3: Write minimal implementation**

1) 新增 `quicker/Panel/ClipboardPanelEntry.swift`：
```swift
import Foundation

struct ClipboardPanelEntry: Equatable {
    let kind: ClipboardEntryKind
    let previewText: String
    let rtfData: Data?
    let imagePath: String?
}
```

2) 修改 `quicker/Panel/ClipboardPanelViewModel.swift`：
- `entries: [String]` → `entries: [ClipboardPanelEntry]`
- `selectedText` → `selectedEntry`
- `textForCmdNumber(_:)` → `entryForCmdNumber(_:)`

3) 修改 `quicker/Panel/ClipboardPanelView.swift`：
- `onPaste: (String) -> Void` → `onPaste: (ClipboardPanelEntry) -> Void`
- 行渲染：
  - `.image`：左侧插入缩略图（`CGImageSourceCreateThumbnailAtIndex` 从 `ClipboardAssetStore.defaultBaseURL()` + `imagePath` 读取）
  - 其它：保持文本预览

4) 修改 `quicker/App/AppState.swift`：
- `refreshPanelEntries()`：从 `ClipboardEntry` 映射到 `ClipboardPanelEntry`：
  - `.text`：`previewText = entry.text`
  - `.rtf`：`previewText = entry.text`, `rtfData = entry.rtfData`
  - `.image`：`previewText = "图片"`, `imagePath = entry.imagePath`

**Step 4: Run test to verify it passes**

Re-run `ClipboardPanelViewModelRichTests`。

Expected: PASS

**Step 5: Commit**

```bash
git add quicker/Panel/ClipboardPanelEntry.swift quicker/Panel/ClipboardPanelViewModel.swift quicker/Panel/ClipboardPanelView.swift quicker/App/AppState.swift quickerTests/ClipboardPanelViewModelRichTests.swift
git commit -m "feat(panel): 支持图片与富文本条目展示"
```

---

### spawn_agent 11: 端到端接线：从面板粘贴 `ClipboardPanelEntry`

**Files:**
- Modify: `quicker/Panel/PanelController.swift`
- Modify: `quicker/App/AppState.swift`

**Step 1: Write the failing test**

系统接线改动，以手测为主：
- 复制 RTF / 图片
- 热键打开面板
- 选中条目按 `Enter`：应写入剪贴板并在授权时自动粘贴

**Step 2: Run test to verify it fails**

跳过（用手测替代）。

**Step 3: Write minimal implementation**

1) 修改 `quicker/Panel/PanelController.swift`：
- `onPaste` 回调类型改为 `(ClipboardPanelEntry, NSRunningApplication?) -> Void`
- `ClipboardPanelView` 传入的 closure 跟随更新

2) 修改 `quicker/App/AppState.swift`：
- `PanelController` 初始化 closure：
  - 根据 `ClipboardPanelEntry.kind` 构造一个临时 `ClipboardEntry`（或直接新增 `PasteService.paste(panelEntry:)`）
  - 对 `.image`：只传 `imagePath`，由 `PasteService` 通过 `assetStore` 读取 pngData
  - 调用 `pasteService.paste(entry:)`

**Step 4: Run test to verify it passes**

做一次 smoke：
- Invoke（xc-all MCP / `xcode_test`）跑全量单测（或至少 `ClipboardStore*` + `PasteServiceLogicTests` + `ClipboardPanelViewModelRichTests`）

**Step 5: Commit**

```bash
git add quicker/Panel/PanelController.swift quicker/App/AppState.swift
git commit -m "feat(app): 从面板粘贴富文本与图片"
```

---

## 2. 手动验收清单（建议）

1) 富文本
- 在 Notes/TextEdit 复制一段加粗/不同颜色的文字
- 打开面板：预览应为纯文本
- 粘贴到 Notes/TextEdit：应保留富文本格式（目标 App 支持时）

2) 图片
- 从 Preview/浏览器复制图片
- 面板显示缩略图
- 粘贴到 Notes/Keynote 等支持图片粘贴的 App：应粘贴出图片

3) 隐私标记过滤
- 从 1Password（或其它标记为 transient 的来源）复制
- 历史不应新增条目

4) 多 item
- 一次复制多段文本（或多选复制）
- 历史只新增 1 条，内容用换行拼接

5) 清理与持久化
- 插入图片后退出 App 重启：图片条目仍可预览与粘贴
- 设置中“清空历史”：图片文件应同步删除（可用日志/临时断点验证）

